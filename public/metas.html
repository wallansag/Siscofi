<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siscofi - Metas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#4299e1', // Azul Siscofi
                        secondary: '#2d3748', // Azul escuro para texto
                        accent: '#48bb78', // Verde para sucesso
                        danger: '#f56565', // Vermelho para erro
                        background: '#f0f2f5', // Fundo claro
                        card: '#ffffff', // Cor dos cards/formulários
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background-color: #2d3748;
            color: #ffffff;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .header .logo {
            height: 3rem;
            filter: brightness(0) invert(1);
        }
        .header nav ul {
            display: flex;
            gap: 1.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .header nav a {
            color: #ffffff;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease-in-out;
        }
        .header nav a:hover {
            color: #4299e1;
        }
        .header .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header .user-info span {
            font-weight: 600;
        }
        .header .btn-logout {
            background-color: #f56565;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out;
        }
        .header .btn-logout:hover {
            background-color: #e53e3e;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            background-color: #f0f2f5;
        }
        .card {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .card h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 1.5rem;
        }
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .meta-item {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background-color: #f8fafc;
        }
        .meta-item h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.75rem;
        }
        .meta-item p {
            color: #4a5568;
            margin-bottom: 0.5rem;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 0.75rem;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #48bb78; /* Verde para progresso */
            width: 0%; /* Será ajustado via JS */
            transition: width 0.5s ease-in-out;
        }
        .btn-add {
            background-color: #48bb78;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            margin-bottom: 1rem;
            display: inline-block;
        }
        .btn-add:hover {
            background-color: #38a169;
        }

        /* Estilos para o Modal de Adicionar Meta */
        .modal {
            display: none; /* Escondido por padrão */
            position: fixed; /* Fica por cima de tudo */
            z-index: 1000; /* Alto z-index para garantir que esteja na frente */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Permite scroll se o conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo preto semi-transparente */
            justify-content: center; /* Centraliza horizontalmente */
            align-items: center; /* Centraliza verticalmente */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Centraliza na tela */
            padding: 20px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%; /* Largura padrão */
            max-width: 500px; /* Largura máxima */
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .modal-content input[type="text"],
        .modal-content input[type="number"],
        .modal-content input[type="date"],
        .modal-content select,
        .modal-content textarea {
            width: calc(100% - 20px); /* Ajusta largura para padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .modal-content button[type="submit"] {
            background-color: #48bb78;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        .modal-content button[type="submit"]:hover {
            background-color: #38a169;
        }
    </style>
</head>
<body>
    <header class="header">
        <img src="CSS/anexos/SISCOFI.png" alt="Logotipo do Siscofi" class="logo">
        <nav>
            <ul>
                <li><a href="tela-inicial.html">Início</a></li>
                <li><a href="movimentacoes.html">Movimentações</a></li>
                <li><a href="metas.html">Metas</a></li>
                <li><a href="relatorios.html">Relatórios</a></li>
            </ul>
        </nav>
        <div class="user-info">
            Olá, <span id="userNameDisplay">Usuário</span>!
            <a href="#" id="logoutButton" class="btn-logout">Sair</a>
        </div>
    </header>

    <main class="main-content">
        <div class="card">
            <h2>Minhas Metas Financeiras</h2>
            <button class="btn-add" id="openModalBtn">Adicionar Nova Meta</button>
            
            <div class="meta-grid" id="metasContainer">
                <div class="meta-item">
                    <h3>Nenhuma meta definida.</h3>
                    <p>Comece a planejar seu futuro financeiro adicionando uma meta!</p>
                </div>
            </div>
        </div>
    </main>

    <div id="metaModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalTitle">Adicionar Nova Meta</h2>
            <form id="metaForm">
                <input type="hidden" id="metaId"> <label for="nome_meta">Nome da Meta:</label>
                <input type="text" id="nome_meta" required>

                <label for="tipo_meta">Tipo de Meta:</label>
                <select id="tipo_meta" required>
                    <option value="">Selecione...</option>
                    <option value="poupança">Poupança</option>
                    <option value="investimento">Investimento</option>
                    <option value="divida">Dívida</option>
                </select>

                <label for="valor_alvo">Valor Alvo:</label>
                <input type="number" id="valor_alvo" step="0.01" required>

                <label for="valor_acumulado">Valor Acumulado (opcional para nova meta):</label>
                <input type="number" id="valor_acumulado" step="0.01" value="0.00">

                <label for="data_limite">Data Limite (opcional):</label>
                <input type="date" id="data_limite">

                <label for="descricao">Descrição:</label>
                <textarea id="descricao" rows="3"></textarea>

                <label for="ativa">Meta Ativa:</label>
                <input type="checkbox" id="ativa" checked>

                <button type="submit">Salvar Meta</button>
            </form>
        </div>
    </div>

    <script type="module">
        const API_URL = 'http://localhost:3000'; // Mantenha isso se seu backend estiver rodando na porta 3000

        document.addEventListener('DOMContentLoaded', async () => {
            const jwtToken = localStorage.getItem('jwtToken'); // Obter o JWT Token
            const userName = localStorage.getItem('userName');
            const logoutButton = document.getElementById('logoutButton');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const metasContainer = document.getElementById('metasContainer');
            const openModalBtn = document.getElementById('openModalBtn');
            const metaModal = document.getElementById('metaModal');
            const closeButton = document.querySelector('.close-button');
            const metaForm = document.getElementById('metaForm');
            const modalTitle = document.getElementById('modalTitle');
            const metaIdInput = document.getElementById('metaId');

            // Redirecionar se não houver JWT Token
            if (!jwtToken) {
                window.location.href = 'index.html';
                return;
            }

            if (userName) {
                userNameDisplay.textContent = userName;
            }

            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('jwtToken'); // Remova o token JWT
                localStorage.removeItem('userId');
                localStorage.removeItem('userName');
                alert('Você foi desconectado.');
                window.location.href = 'index.html';
            });

            // --- Funções do Modal ---
            openModalBtn.addEventListener('click', () => {
                metaForm.reset(); // Limpa o formulário
                metaIdInput.value = ''; // Garante que não é uma edição
                modalTitle.textContent = 'Adicionar Nova Meta';
                document.getElementById('ativa').checked = true; // Nova meta é ativa por padrão
                metaModal.style.display = 'flex'; // Exibe o modal
            });

            closeButton.addEventListener('click', () => {
                metaModal.style.display = 'none'; // Esconde o modal
            });

            // Fechar modal clicando fora
            window.addEventListener('click', (event) => {
                if (event.target == metaModal) {
                    metaModal.style.display = 'none';
                }
            });

            // --- Função para Carregar Metas ---
            async function loadMetas() {
                try {
                    const response = await fetch(`${API_URL}/metas`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}` // Envia o token JWT
                        }
                    });

                    if (response.status === 403) {
                        alert('Sessão expirada. Faça login novamente.');
                        localStorage.removeItem('jwtToken');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        window.location.href = 'index.html';
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const metas = await response.json();
                    metasContainer.innerHTML = ''; // Limpa o container

                    if (metas.length === 0) {
                        metasContainer.innerHTML = `
                            <div class="meta-item">
                                <h3>Nenhuma meta definida.</h3>
                                <p>Comece a planejar seu futuro financeiro adicionando uma meta!</p>
                            </div>
                        `;
                        return;
                    }

                    metas.forEach(meta => {
                        const metaItem = document.createElement('div');
                        metaItem.classList.add('card', 'meta-item');

                        // Garante que valor_alvo e valor_acumulado são números para cálculo
                        const valorAlvo = parseFloat(meta.valor_alvo);
                        const valorAcumulado = parseFloat(meta.valor_acumulado);

                        const progresso = (valorAcumulado / valorAlvo) * 100;
                        const valorAlvoFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorAlvo);
                        const valorAcumuladoFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorAcumulado);
                        const dataLimiteFormatada = meta.data_limite ? new Date(meta.data_limite).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'Sem prazo'; // Evita erro de fuso horário

                        metaItem.innerHTML = `
                            <h3>${meta.nome_meta} (${meta.tipo_meta})</h3>
                            <p>${meta.descricao || 'Nenhuma descrição.'}</p>
                            <p>Alvo: ${valorAlvoFormatado}</p>
                            <p>Atual: ${valorAcumuladoFormatado}</p>
                            <p>Prazo: ${dataLimiteFormatada}</p>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${Math.min(progresso, 100).toFixed(2)}%;"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">${progresso.toFixed(2)}% concluído</p>
                            <div class="mt-4 flex justify-end">
                                <button class="text-blue-500 hover:text-blue-700 mr-2 edit-btn" data-id="${meta.id}"><i class="fas fa-edit"></i></button>
                                <button class="text-red-500 hover:text-red-700 delete-btn" data-id="${meta.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        `;
                        metasContainer.appendChild(metaItem);
                    });

                    // Adicionar listeners para os botões de editar e deletar
                    document.querySelectorAll('.edit-btn').forEach(button => {
                        button.addEventListener('click', (event) => openEditModal(event.target.dataset.id));
                    });
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', (event) => deleteMeta(event.target.dataset.id));
                    });

                } catch (error) {
                    console.error('Erro ao carregar metas:', error);
                    metasContainer.innerHTML = `
                        <div class="meta-item">
                            <h3 class="text-red-500">Erro ao carregar metas.</h3>
                            <p class="text-red-500">Tente novamente mais tarde.</p>
                        </div>
                    `;
                }
            }

            // --- Função para Enviar Formulário de Meta ---
            metaForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const id = metaIdInput.value;
                const nome_meta = document.getElementById('nome_meta').value;
                const tipo_meta = document.getElementById('tipo_meta').value;
                const valor_alvo = parseFloat(document.getElementById('valor_alvo').value);
                const valor_acumulado = parseFloat(document.getElementById('valor_acumulado').value);
                const data_limite = document.getElementById('data_limite').value;
                const descricao = document.getElementById('descricao').value;
                const ativa = document.getElementById('ativa').checked;

                const metaData = {
                    nome_meta,
                    tipo_meta,
                    valor_alvo,
                    valor_acumulado,
                    data_limite: data_limite || null, // Envia null se vazio
                    descricao,
                    ativa
                };

                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API_URL}/metas/${id}` : `${API_URL}/metas`;

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        },
                        body: JSON.stringify(metaData)
                    });

                    if (response.status === 403) {
                        alert('Sessão expirada. Faça login novamente.');
                        localStorage.removeItem('jwtToken');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        window.location.href = 'index.html';
                        return;
                    }

                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message);
                        metaModal.style.display = 'none'; // Fecha o modal
                        loadMetas(); // Recarrega a lista de metas
                    } else {
                        alert('Erro ao salvar meta: ' + result.message);
                    }
                } catch (error) {
                    console.error('Erro ao salvar meta:', error);
                    alert('Erro de conexão ao salvar meta. Tente novamente mais tarde.');
                }
            });

            // --- Função para Abrir Modal de Edição ---
            async function openEditModal(metaId) {
                try {
                    const response = await fetch(`${API_URL}/metas/${metaId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        }
                    });

                    if (response.status === 403) {
                        alert('Sessão expirada. Faça login novamente.');
                        localStorage.removeItem('jwtToken');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        window.location.href = 'index.html';
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const meta = await response.json();

                    modalTitle.textContent = 'Editar Meta';
                    metaIdInput.value = meta.id;
                    document.getElementById('nome_meta').value = meta.nome_meta;
                    document.getElementById('tipo_meta').value = meta.tipo_meta;
                    document.getElementById('valor_alvo').value = meta.valor_alvo;
                    document.getElementById('valor_acumulado').value = meta.valor_acumulado;
                    // Formata a data para YYYY-MM-DD para o input type="date"
                    document.getElementById('data_limite').value = meta.data_limite ? new Date(meta.data_limite).toISOString().split('T')[0] : '';
                    document.getElementById('descricao').value = meta.descricao;
                    document.getElementById('ativa').checked = meta.ativa;

                    metaModal.style.display = 'flex'; // Exibe o modal
                } catch (error) {
                    console.error('Erro ao carregar meta para edição:', error);
                    alert('Erro ao carregar dados da meta para edição.');
                }
            }

            // --- Função para Deletar Meta ---
            async function deleteMeta(metaId) {
                if (!confirm('Tem certeza que deseja excluir esta meta?')) {
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/metas/${metaId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        }
                    });

                    if (response.status === 403) {
                        alert('Sessão expirada. Faça login novamente.');
                        localStorage.removeItem('jwtToken');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        window.location.href = 'index.html';
                        return;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! status: ${response.status} - ${errorData.message}`);
                    }

                    alert('Meta excluída com sucesso!');
                    loadMetas(); // Recarrega a lista
                } catch (error) {
                    console.error('Erro ao excluir meta:', error);
                    alert('Erro ao excluir meta: ' + error.message);
                }
            }


            loadMetas(); // Carrega as metas ao carregar a página
        });
    </script>
</body>
</html>